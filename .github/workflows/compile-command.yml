name: Compile Command
on:
  repository_dispatch:
    types: [compile-command]

env:
  arg1: ${{ github.event.client_payload.slash_command.args.unnamed.arg1 }}
  arg2: ${{ github.event.client_payload.slash_command.args.unnamed.arg2 }}

jobs:
  compile:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          # ref: ${{ github.event.client_payload.ref }}
          token: ${{ secrets.DEPENDABOT_AUTOMERGE_TOKEN }}
          repository: ${{ github.event.client_payload.pull_request.head.repo.full_name }}
          ref: ${{ github.event.client_payload.pull_request.head.ref }}

      - name: Read package.json node and npm engines version
        uses: skjnldsv/read-package-engines-version-actions@v1
        id: package-engines-versions

      - name: Show node version number
        run: echo "Node version is ${{ steps.package-engines-versions.outputs.nodeVersion }}"

      - name: Show npm version number
        run: echo "Npm version is ${{ steps.package-engines-versions.outputs.npmVersion }}"

      - name: Set up node
        uses: actions/setup-node@v2
        with:
          node-version: ${{ steps.package-engines-versions.outputs.nodeVersion }}

      - name: Set up npm
        run: npm i -g npm"@${{ steps.package-engines-versions.outputs.npmVersion }}"

      - name: Install dependencies & build
        run: |
          npm ci
          npm run build --if-present

      - name: Check  changes
        run: |
          bash -c "git status"

      - name: Add & Commit default
        uses: stefanzweifel/git-auto-commit-action@v4
        # If the first argument starts with a /
        if: ${{ startsWith(env.arg1, '/') }}
        with:
          file_pattern: ${{ github.workspace }}${{ env.arg1 }}
          commit_message: 'Compile assets'
          commit_options: '--signoff'

      - name: Add & Commit fixup
        uses: stefanzweifel/git-auto-commit-action@v4
        if: ${{ env.arg1 == 'fixup' }}
        with:
          file_pattern: ${{ github.workspace }}${{ env.arg2 }}
          commit_options: '--fixup=HEAD --signoff'
          push_options: '--force'

      - name: Add & Commit amend
        uses: stefanzweifel/git-auto-commit-action@v4
        if: ${{ env.arg1 == 'amend' }}
        with:
          file_pattern: ${{ github.workspace }}${{ env.arg2 }}
          commit_options: '--amend --signoff'
          push_options: '--force'
